<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en_US" lang="en_US">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- undoframework.qdoc -->
  <title>Qt 4.7: Undo Framework Example</title>
  <link rel="stylesheet" type="text/css" href="style/style.css" />
  <script src="scripts/jquery.js" type="text/javascript"></script>
  <script src="scripts/functions.js" type="text/javascript"></script>
</head>
<body class="offline narrow creator">
 <div class="header" id="qtdocheader">
    <div class="content"> 
    <div id="nav-logo">
      <a href="index.html">Home</a></div>
    <a href="index.html" class="qtref"><span>Qt Reference Documentation</span></a>
		<div id="narrowsearch"><form onsubmit="return false;" action="" id="qtdocsearch">
		<fieldset>
		<input type="text" value="" id="pageType2" name="searchstring"/>
		 </fieldset>
		</form></div>
    <div id="nav-topright">
      <ul>
        <li class="nav-topright-home"><a href="http://qt.nokia.com/">Qt HOME</a></li>
        <li class="nav-topright-dev"><a href="http://developer.qt.nokia.com/">DEV</a></li>
        <li class="nav-topright-labs"><a href="http://labs.qt.nokia.com/blogs/">LABS</a></li>
        <li class="nav-topright-doc nav-topright-doc-active"><a href="http://doc.qt.nokia.com/">
          DOC</a></li>
        <li class="nav-topright-blog"><a href="http://blog.qt.nokia.com/">BLOG</a></li>
      </ul>
    </div>
    <div id="shortCut">
      <ul>
        <li class="shortCut-topleft-inactive"><span><a href="index.html">Qt 4.7</a></span></li>
        <li class="shortCut-topleft-active"><a href="http://qt.nokia.com/doc/">ALL VERSIONS        </a></li>
      </ul>
     </div>
 <ul class="sf-menu sf-js-enabled sf-shadow" id="narrowmenu"> 
		 <li><a href="#">API Lookup</a> 
			 <ul id="topmenuLook"> 
			   <li><a href="classes.html">Class index</a></li> 
 			  <li><a href="functions.html">Function index</a></li> 
			   <li><a href="modules.html">Modules</a></li> 
			   <li><a href="namespaces.html">Namespaces</a></li> 
			   <li><a href="qtglobal.html">Global stuff</a></li> 
			   <li><a href="qdeclarativeelements.html">QML elements</a></li> 
			   </ul> 
		 </li> 
		 <li><a href="#">Qt Topics</a> 
			 <ul id="topmenuTopic"> 
			   <li><a href="qt-basic-concepts.html">Basic Qt architecture</a></li> 
			   <li><a href="qtquick.html">Device UI's &amp; Qt Quick</a></li> 
			   <li><a href="qt-gui-concepts.html">Desktop UI components</a></li> 
			   <li><a href="platform-specific.html">Platform-specific info</a></li> 
			   <li><a href="best-practices.html">How-To's and Best Practices</a></li> 
			 </ul> 
		</li> 
		 <li><a href="#">Examples</a> 
			 <ul id="topmenuexample"> 
				 <li><a href="all-examples.html">Examples</a></li> 
				 <li><a href="tutorials.html">Tutorials</a></li> 
				 <li><a href="demos.html">Demos</a></li> 
				 <li><a href="qdeclarativeexamples.html">QML Examples</a></li> 
			 </ul> 
		 </li> 
 </ul> 
    </div>
  </div>
  <div class="wrapper">
    <div class="hd">
      <span></span>
    </div>
    <div class="bd group">
      <div class="sidebar">
        <div class="searchlabel">
          Search index:</div>
        <div class="search">
          <form id="qtdocsearch" action="" onsubmit="return false;">
            <fieldset>
              <input type="text" name="searchstring" id="pageType" value="" />
            </fieldset>
          </form>
        </div>
        <div class="box first bottombar" id="lookup">
          <h2 title="API Lookup"><span></span>
            API Lookup</h2>
          <div  id="list001" class="list">
          <ul id="ul001" >
              <li class="defaultLink"><a href="classes.html">Class index</a></li>
              <li class="defaultLink"><a href="functions.html">Function index</a></li>
              <li class="defaultLink"><a href="modules.html">Modules</a></li>
              <li class="defaultLink"><a href="namespaces.html">Namespaces</a></li>
              <li class="defaultLink"><a href="qtglobal.html">Global stuff</a></li>
              <li class="defaultLink"><a href="qdeclarativeelements.html">QML elements</a></li>
            </ul> 
          </div>
        </div>
        <div class="box bottombar" id="topics">
          <h2 title="Qt Topics"><span></span>
            Qt Topics</h2>
          <div id="list002" class="list">
            <ul id="ul002" >
              <li class="defaultLink"><a href="qt-basic-concepts.html">Basic Qt architecture</a></li>
              <li class="defaultLink"><a href="qtquick.html">Device UI's &amp; Qt Quick</a></li>
              <li class="defaultLink"><a href="qt-gui-concepts.html">Desktop UI components</a></li>
              <li class="defaultLink"><a href="platform-specific.html">Platform-specific info</a></li>
            </ul>  
          </div>
        </div>
        <div class="box" id="examples">
          <h2 title="Examples"><span></span>
            Examples</h2>
          <div id="list003" class="list">
        <ul id="ul003">
              <li class="defaultLink"><a href="all-examples.html">Examples</a></li>
              <li class="defaultLink"><a href="tutorials.html">Tutorials</a></li>
              <li class="defaultLink"><a href="demos.html">Demos</a></li>
              <li class="defaultLink"><a href="qdeclarativeexamples.html">QML Examples</a></li>
            </ul> 
          </div>
        </div>
      </div>
      <div class="wrap">
        <div class="toolbar">
          <div class="breadcrumb toolblock">
            <ul>
              <li class="first"><a href="index.html">Home</a></li>
              <!--  Bread crumbs goes here -->
              <li><a href="all-examples.html">Examples</a></li>              <li><a href="examples-tools.html"></a></li>              <li>Undo Framework Example</li>            </ul>
          </div>
          <div class="toolbuttons toolblock">
            <ul>
              <li id="smallA" class="t_button">A</li>
              <li id="medA" class="t_button active">A</li>
              <li id="bigA" class="t_button">A</li>
              <li id="print" class="t_button"><a href="javascript:this.print();">
                <span>Print</span></a></li>
            </ul>
          </div>
        </div>
        <div class="content">
<div class="toc">
<h3><a name="toc">Contents</a></h3>
<ul>
<li class="level1"><a href="#mainwindow-class-definition">MainWindow Class Definition</a></li>
<li class="level1"><a href="#mainwindow-class-implementation">MainWindow Class Implementation</a></li>
<li class="level1"><a href="#addcommand-class-definition">AddCommand Class Definition</a></li>
<li class="level1"><a href="#addcommand-class-implementation">AddCommand Class Implementation</a></li>
<li class="level1"><a href="#deletecommand-class-definition">DeleteCommand Class Definition</a></li>
<li class="level1"><a href="#deletecommand-class-implementation">DeleteCommand Class Implementation</a></li>
<li class="level1"><a href="#movecommand-class-definition">MoveCommand Class Definition</a></li>
<li class="level1"><a href="#movecommand-class-implementation">MoveCommand Class Implementation</a></li>
<li class="level1"><a href="#diagramscene-class-definition">DiagramScene Class Definition</a></li>
<li class="level1"><a href="#the-function">The <tt>main()</tt> Function</a></li>
</ul>
</div>
<h1 class="title">Undo Framework Example</h1>
<span class="subtitle"></span>
<!-- $$$tools/undoframework-description -->
<div class="descr"> <a name="details"></a>
<p>Files:</p>
<ul>
<li><a href="tools-undoframework-commands-cpp.html">tools/undoframework/commands.cpp</a></li>
<li><a href="tools-undoframework-commands-h.html">tools/undoframework/commands.h</a></li>
<li><a href="tools-undoframework-diagramitem-cpp.html">tools/undoframework/diagramitem.cpp</a></li>
<li><a href="tools-undoframework-diagramitem-h.html">tools/undoframework/diagramitem.h</a></li>
<li><a href="tools-undoframework-diagramscene-cpp.html">tools/undoframework/diagramscene.cpp</a></li>
<li><a href="tools-undoframework-diagramscene-h.html">tools/undoframework/diagramscene.h</a></li>
<li><a href="tools-undoframework-mainwindow-cpp.html">tools/undoframework/mainwindow.cpp</a></li>
<li><a href="tools-undoframework-mainwindow-h.html">tools/undoframework/mainwindow.h</a></li>
<li><a href="tools-undoframework-main-cpp.html">tools/undoframework/main.cpp</a></li>
<li><a href="tools-undoframework-undoframework-pro.html">tools/undoframework/undoframework.pro</a></li>
<li><a href="tools-undoframework-undoframework-qrc.html">tools/undoframework/undoframework.qrc</a></li>
</ul>
<p>Images:</p>
<ul>
<li><a href="images/used-in-examples/tools/undoframework/images/cross.png">tools/undoframework/images/cross.png</a></li>
</ul>
<p>This example shows how to implement undo/redo functionality with the Qt undo framework.</p>
<p class="centerAlign"><img src="images/undoframeworkexample.png" alt="The Undo Diagram Example" /></p><p>In the Qt undo framework, all actions that the user performs are implemented in classes that inherit <a href="qundocommand.html">QUndoCommand</a>. An undo command class knows how to both <a href="qundocommand.html#redo">redo()</a> - or just do the first time - and <a href="qundocommand.html#undo">undo()</a> an action. For each action the user performs, a command is placed on a <a href="qundostack.html">QUndoStack</a>. Since the stack contains all commands executed (stacked in chronological order) on the document, it can roll the state of the document backwards and forwards by undoing and redoing its commands. See the <a href="qundo.html">overview document</a> for a high-level introduction to the undo framework.</p>
<p>The undo example implements a simple diagram application. It is possible to add and delete items, which are either box or rectangular shaped, and move the items by dragging them with the mouse. The undo stack is shown in a <a href="qundoview.html">QUndoView</a>, which is a list in which the commands are shown as list items. Undo and redo are available through the edit menu. The user can also select a command from the undo view.</p>
<p>We use the <a href="graphicsview.html">graphics view framework</a> to implement the diagram. We only treat the related code briefly as the framework has examples of its own (e.g&#x2e;, the <a href="graphicsview-diagramscene.html">Diagram Scene Example</a>).</p>
<p>The example consists of the following classes:</p>
<ul>
<li><tt>MainWindow</tt> is the main window and arranges the example's widgets. It creates the commands based on user input and keeps them on the command stack.</li>
<li><tt>AddCommand</tt> adds an item to the scene.</li>
<li><tt>DeleteCommand</tt> deletes an item from the scene.</li>
<li><tt>MoveCommand</tt> when an item is moved the MoveCommand keeps record of the start and stop positions of the move, and it moves the item according to these when <tt>redo()</tt> and <tt>undo()</tt> is called.</li>
<li><tt>DiagramScene</tt> inherits <a href="qgraphicsscene.html">QGraphicsScene</a> and emits signals for the <tt>MoveComands</tt> when an item is moved.</li>
<li><tt>DiagramItem</tt> inherits <a href="qgraphicspolygonitem.html">QGraphicsPolygonItem</a> and represents an item in the diagram.</li>
</ul>
<a name="mainwindow-class-definition"></a>
<h2>MainWindow Class Definition</h2>
<pre class="highlightedCode brush: cpp"> class MainWindow : public QMainWindow
 {
     Q_OBJECT

 public:
     MainWindow();

 public slots:
     void itemMoved(DiagramItem *movedDiagram, const QPointF &amp;moveStartPosition);

 private slots:
     void deleteItem();
     void addBox();
     void addTriangle();
     void about();
     void itemMenuAboutToShow();
     void itemMenuAboutToHide();

 private:
     void createActions();
     void createMenus();
     void createUndoView();

     QAction *deleteAction;
     QAction *addBoxAction;
     QAction *addTriangleAction;
     QAction *undoAction;
     QAction *redoAction;
     QAction *exitAction;
     QAction *aboutAction;

     QMenu *fileMenu;
     QMenu *editMenu;
     QMenu *itemMenu;
     QMenu *helpMenu;

     DiagramScene *diagramScene;
     QUndoStack *undoStack;
     QUndoView *undoView;
 };</pre>
<p>The <tt>MainWindow</tt> class maintains the undo stack, i.e&#x2e;, it creates <a href="qundocommand.html">QUndoCommand</a>s and pushes and pops them from the stack when it receives the <tt>triggered()</tt> signal from <tt>undoAction</tt> and <tt>redoAction</tt>.</p>
<a name="mainwindow-class-implementation"></a>
<h2>MainWindow Class Implementation</h2>
<p>We will start with a look at the constructor:</p>
<pre class="highlightedCode brush: cpp"> MainWindow::MainWindow()
 {
     undoStack = new QUndoStack();

     createActions();
     createMenus();

     createUndoView();

     diagramScene = new DiagramScene();
     QBrush pixmapBrush(QPixmap(&quot;:/images/cross.png&quot;).scaled(30, 30));
     diagramScene-&gt;setBackgroundBrush(pixmapBrush);
     diagramScene-&gt;setSceneRect(QRect(0, 0, 500, 500));

     connect(diagramScene, SIGNAL(itemMoved(DiagramItem*,QPointF)),
             this, SLOT(itemMoved(DiagramItem*,QPointF)));

     setWindowTitle(&quot;Undo Framework&quot;);
     QGraphicsView *view = new QGraphicsView(diagramScene);
     setCentralWidget(view);
     resize(700, 500);
 }</pre>
<p>In the constructor, we set up the DiagramScene and <a href="qgraphicsview.html">QGraphicsView</a>.</p>
<p>Here is the <tt>createUndoView()</tt> function:</p>
<pre class="highlightedCode brush: cpp"> void MainWindow::createUndoView()
 {
     undoView = new QUndoView(undoStack);
     undoView-&gt;setWindowTitle(tr(&quot;Command List&quot;));
     undoView-&gt;show();
     undoView-&gt;setAttribute(Qt::WA_QuitOnClose, false);
 }</pre>
<p>The <a href="qundoview.html">QUndoView</a> is a widget that display the text, which is set with the <a href="qundocommand.html#setText">setText()</a> function, for each <a href="qundocommand.html">QUndoCommand</a> in the undo stack in a list.</p>
<p>Here is the <tt>createActions()</tt> function:</p>
<pre class="highlightedCode brush: cpp"> void MainWindow::createActions()
 {
     deleteAction = new QAction(tr(&quot;&amp;Delete Item&quot;), this);
     deleteAction-&gt;setShortcut(tr(&quot;Del&quot;));
     connect(deleteAction, SIGNAL(triggered()), this, SLOT(deleteItem()));

     ...
     undoAction = undoStack-&gt;createUndoAction(this, tr(&quot;&amp;Undo&quot;));
     undoAction-&gt;setShortcuts(QKeySequence::Undo);

     redoAction = undoStack-&gt;createRedoAction(this, tr(&quot;&amp;Redo&quot;));
     redoAction-&gt;setShortcuts(QKeySequence::Redo);</pre>
<p>The <tt>createActions()</tt> function sets up all the examples actions in the manner shown above. The <a href="qundostack.html#createUndoAction">createUndoAction()</a> and <a href="qundostack.html#createRedoAction">createRedoAction()</a> helps us crate actions that are disabled and enabled based on the state of the stack. Also, the text of the action will be updated automatically based on the <a href="qundocommand.html#text">text()</a> of the undo commands. For the other actions we have implemented slots in the <tt>MainWindow</tt> class.</p>
<p>Here is the <tt>createMenus()</tt> function:</p>
<pre class="highlightedCode brush: cpp"> void MainWindow::createMenus()
 {
     ...
     editMenu = menuBar()-&gt;addMenu(tr(&quot;&amp;Edit&quot;));
     editMenu-&gt;addAction(undoAction);
     editMenu-&gt;addAction(redoAction);
     editMenu-&gt;addSeparator();
     editMenu-&gt;addAction(deleteAction);
     connect(editMenu, SIGNAL(aboutToShow()),
             this, SLOT(itemMenuAboutToShow()));
     connect(editMenu, SIGNAL(aboutToHide()),
             this, SLOT(itemMenuAboutToHide()));

     ...
 }</pre>
<p>We have to use the <a href="qmenu.html">QMenu</a> <tt>aboutToShow()</tt> and <tt>aboutToHide()</tt> signals since we only want <tt>deleteAction</tt> to be enabled when we have selected an item.</p>
<p>Here is the <tt>itemMoved()</tt> slot:</p>
<pre class="highlightedCode brush: cpp"> void MainWindow::itemMoved(DiagramItem *movedItem,
                            const QPointF &amp;oldPosition)
 {
     undoStack-&gt;push(new MoveCommand(movedItem, oldPosition));
 }</pre>
<p>We simply push a MoveCommand on the stack, which calls <tt>redo()</tt> on it.</p>
<p>Here is the <tt>deleteItem()</tt> slot:</p>
<pre class="highlightedCode brush: cpp"> void MainWindow::deleteItem()
 {
     if (diagramScene-&gt;selectedItems().isEmpty())
         return;

     QUndoCommand *deleteCommand = new DeleteCommand(diagramScene);
     undoStack-&gt;push(deleteCommand);
 }</pre>
<p>An item must be selected to be deleted. We need to check if it is selected as the <tt>deleteAction</tt> may be enabled even if an item is not selected. This can happen as we do not catch a signal or event when an item is selected.</p>
<p>Here is the <tt>itemMenuAboutToShow()</tt> and itemMenuAboutToHide() slots:</p>
<pre class="highlightedCode brush: cpp"> void MainWindow::itemMenuAboutToHide()
 {
     deleteAction-&gt;setEnabled(true);
 }

 void MainWindow::itemMenuAboutToShow()
 {
     deleteAction-&gt;setEnabled(!diagramScene-&gt;selectedItems().isEmpty());
 }</pre>
<p>We implement <tt>itemMenuAboutToShow()</tt> and <tt>itemMenuAboutToHide()</tt> to get a dynamic item menu. These slots are connected to the <a href="qmenu.html#aboutToShow">aboutToShow()</a> and <a href="qmenu.html#aboutToHide">aboutToHide()</a> signals. We need this to disable or enable the <tt>deleteAction</tt>.</p>
<p>Here is the <tt>addBox()</tt> slot:</p>
<pre class="highlightedCode brush: cpp"> void MainWindow::addBox()
 {
     QUndoCommand *addCommand = new AddCommand(DiagramItem::Box, diagramScene);
     undoStack-&gt;push(addCommand);
 }</pre>
<p>The <tt>addBox()</tt> function creates an AddCommand and pushes it on the undo stack.</p>
<p>Here is the <tt>addTriangle()</tt> sot:</p>
<pre class="highlightedCode brush: cpp"> void MainWindow::addTriangle()
 {
     QUndoCommand *addCommand = new AddCommand(DiagramItem::Triangle,
                                               diagramScene);
     undoStack-&gt;push(addCommand);
 }</pre>
<p>The <tt>addTriangle()</tt> function creates an AddCommand and pushes it on the undo stack.</p>
<p>Here is the implementation of <tt>about()</tt>:</p>
<pre class="highlightedCode brush: cpp"> void MainWindow::about()
 {
     QMessageBox::about(this, tr(&quot;About Undo&quot;),
                        tr(&quot;The &lt;b&gt;Undo&lt;/b&gt; example demonstrates how to &quot;
                           &quot;use Qt's undo framework.&quot;));
 }</pre>
<p>The about slot is triggered by the <tt>aboutAction</tt> and displays an about box for the example.</p>
<a name="addcommand-class-definition"></a>
<h2>AddCommand Class Definition</h2>
<pre class="highlightedCode brush: cpp"> class AddCommand : public QUndoCommand
 {
 public:
     AddCommand(DiagramItem::DiagramType addType, QGraphicsScene *graphicsScene,
                QUndoCommand *parent = 0);

     void undo();
     void redo();

 private:
     DiagramItem *myDiagramItem;
     QGraphicsScene *myGraphicsScene;
     QPointF initialPosition;
 };</pre>
<p>The <tt>AddCommand</tt> class adds DiagramItem graphics items to the DiagramScene.</p>
<a name="addcommand-class-implementation"></a>
<h2>AddCommand Class Implementation</h2>
<p>We start with the constructor:</p>
<pre class="highlightedCode brush: cpp"> AddCommand::AddCommand(DiagramItem::DiagramType addType,
                        QGraphicsScene *scene, QUndoCommand *parent)
     : QUndoCommand(parent)
 {
     static int itemCount = 0;

     myGraphicsScene = scene;
     myDiagramItem = new DiagramItem(addType);
     initialPosition = QPointF((itemCount * 15) % int(scene-&gt;width()),
                               (itemCount * 15) % int(scene-&gt;height()));
     scene-&gt;update();
     ++itemCount;
     setText(QObject::tr(&quot;Add %1&quot;)
         .arg(createCommandString(myDiagramItem, initialPosition)));
 }</pre>
<p>We first create the DiagramItem to add to the DiagramScene. The <a href="qundocommand.html#setText">setText()</a> function let us set a <a href="qstring.html">QString</a> that describes the command. We use this to get custom messages in the <a href="qundoview.html">QUndoView</a> and in the menu of the main window.</p>
<pre class="highlightedCode brush: cpp"> void AddCommand::undo()
 {
     myGraphicsScene-&gt;removeItem(myDiagramItem);
     myGraphicsScene-&gt;update();
 }</pre>
<p><tt>undo()</tt> removes the item from the scene. We need to update the scene as ..&#x2e;(ask Andreas)</p>
<pre class="highlightedCode brush: cpp"> void AddCommand::redo()
 {
     myGraphicsScene-&gt;addItem(myDiagramItem);
     myDiagramItem-&gt;setPos(initialPosition);
     myGraphicsScene-&gt;clearSelection();
     myGraphicsScene-&gt;update();
 }</pre>
<p>We set the position of the item as we do not do this in the constructor.</p>
<a name="deletecommand-class-definition"></a>
<h2>DeleteCommand Class Definition</h2>
<pre class="highlightedCode brush: cpp"> class DeleteCommand : public QUndoCommand
 {
 public:
     DeleteCommand(QGraphicsScene *graphicsScene, QUndoCommand *parent = 0);

     void undo();
     void redo();

 private:
     DiagramItem *myDiagramItem;
     QGraphicsScene *myGraphicsScene;
 };</pre>
<p>The DeleteCommand class implements the functionality to remove an item from the scene.</p>
<a name="deletecommand-class-implementation"></a>
<h2>DeleteCommand Class Implementation</h2>
<pre class="highlightedCode brush: cpp"> DeleteCommand::DeleteCommand(QGraphicsScene *scene, QUndoCommand *parent)
     : QUndoCommand(parent)
 {
     myGraphicsScene = scene;
     QList&lt;QGraphicsItem *&gt; list = myGraphicsScene-&gt;selectedItems();
     list.first()-&gt;setSelected(false);
     myDiagramItem = static_cast&lt;DiagramItem *&gt;(list.first());
     setText(QObject::tr(&quot;Delete %1&quot;)
         .arg(createCommandString(myDiagramItem, myDiagramItem-&gt;pos())));
 }</pre>
<p>We know that there must be one selected item as it is not possible to create a DeleteCommand unless the item to be deleted is selected and that only one item can be selected at any time. The item must be unselected if it is inserted back into the scene.</p>
<pre class="highlightedCode brush: cpp"> void DeleteCommand::undo()
 {
     myGraphicsScene-&gt;addItem(myDiagramItem);
     myGraphicsScene-&gt;update();
 }</pre>
<p>The item is simply reinserted into the scene.</p>
<pre class="highlightedCode brush: cpp"> void DeleteCommand::redo()
 {
     myGraphicsScene-&gt;removeItem(myDiagramItem);
 }</pre>
<p>The item is removed from the scene.</p>
<a name="movecommand-class-definition"></a>
<h2>MoveCommand Class Definition</h2>
<pre class="highlightedCode brush: cpp"> class MoveCommand : public QUndoCommand
 {
 public:
     enum { Id = 1234 };

     MoveCommand(DiagramItem *diagramItem, const QPointF &amp;oldPos,
                 QUndoCommand *parent = 0);

     void undo();
     void redo();
     bool mergeWith(const QUndoCommand *command);
     int id() const { return Id; }

 private:
     DiagramItem *myDiagramItem;
     QPointF myOldPos;
     QPointF newPos;
 };</pre>
<p>The <a href="qundocommand.html#mergeWith">mergeWith()</a> is reimplemented to make consecutive moves of an item one MoveCommand, i.e, the item will be moved back to the start position of the first move.</p>
<a name="movecommand-class-implementation"></a>
<h2>MoveCommand Class Implementation</h2>
<p>The constructor of MoveCommand looks like this:</p>
<pre class="highlightedCode brush: cpp"> MoveCommand::MoveCommand(DiagramItem *diagramItem, const QPointF &amp;oldPos,
                  QUndoCommand *parent)
     : QUndoCommand(parent)
 {
     myDiagramItem = diagramItem;
     newPos = diagramItem-&gt;pos();
     myOldPos = oldPos;
 }</pre>
<p>We save both the old and new positions for undo and redo respectively.</p>
<pre class="highlightedCode brush: cpp"> void MoveCommand::undo()
 {
     myDiagramItem-&gt;setPos(myOldPos);
     myDiagramItem-&gt;scene()-&gt;update();
     setText(QObject::tr(&quot;Move %1&quot;)
         .arg(createCommandString(myDiagramItem, newPos)));
 }</pre>
<p>We simply set the items old position and update the scene.</p>
<pre class="highlightedCode brush: cpp"> void MoveCommand::redo()
 {
     myDiagramItem-&gt;setPos(newPos);
     setText(QObject::tr(&quot;Move %1&quot;)
         .arg(createCommandString(myDiagramItem, newPos)));
 }</pre>
<p>We set the item to its new position.</p>
<pre class="highlightedCode brush: cpp"> bool MoveCommand::mergeWith(const QUndoCommand *command)
 {
     const MoveCommand *moveCommand = static_cast&lt;const MoveCommand *&gt;(command);
     DiagramItem *item = moveCommand-&gt;myDiagramItem;

     if (myDiagramItem != item)
     return false;

     newPos = item-&gt;pos();
     setText(QObject::tr(&quot;Move %1&quot;)
         .arg(createCommandString(myDiagramItem, newPos)));

     return true;
 }</pre>
<p>Whenever a MoveCommand is created, this function is called to check if it should be merged with the previous command. It is the previous command object that is kept on the stack. The function returns true if the command is merged; otherwise false.</p>
<p>We first check whether it is the same item that has been moved twice, in which case we merge the commands. We update the position of the item so that it will take the last position in the move sequence when undone.</p>
<a name="diagramscene-class-definition"></a>
<h2>DiagramScene Class Definition</h2>
<pre class="highlightedCode brush: cpp"> class DiagramScene : public QGraphicsScene
 {
     Q_OBJECT

 public:
     DiagramScene(QObject *parent = 0);

 signals:
     void itemMoved(DiagramItem *movedItem, const QPointF &amp;movedFromPosition);

 protected:
     void mousePressEvent(QGraphicsSceneMouseEvent *event);
     void mouseReleaseEvent(QGraphicsSceneMouseEvent *event);

 private:
     QGraphicsItem *movingItem;
     QPointF oldPos;
 };</pre>
<p>The DiagramScene implements the functionality to move a DiagramItem with the mouse. It emits a signal when a move is completed. This is caught by the <tt>MainWindow</tt>, which makes MoveCommands. We do not examine the implementation of DiagramScene as it only deals with graphics framework issues.</p>
<a name="the-function"></a>
<h2>The <tt>main()</tt> Function</h2>
<p>The <tt>main()</tt> function of the program looks like this:</p>
<pre class="highlightedCode brush: cpp"> int main(int argv, char *args[])
 {
     Q_INIT_RESOURCE(undoframework);

     QApplication app(argv, args);

     MainWindow mainWindow;
     mainWindow.show();

     return app.exec();
 }</pre>
<p>We draw a grid in the background of the DiagramScene, so we use a resource file. The rest of the function creates the <tt>MainWindow</tt> and shows it as a top level window.</p>
</div>
<!-- @@@tools/undoframework -->
        <!-- /div -->
        <div class="feedback t_button">
          [+] Documentation Feedback</div>
      </div>
    </div>
    <div class="ft">
      <span></span>
    </div>
  </div> 
  <div class="footer">
    <p>
      <acronym title="Copyright">&copy;</acronym> 2008-2010 Nokia Corporation and/or its
      subsidiaries. Nokia, Qt and their respective logos are trademarks of Nokia Corporation 
      in Finland and/or other countries worldwide.</p>
    <p>
      All other trademarks are property of their respective owners. <a title="Privacy Policy"
        href="http://qt.nokia.com/about/privacy-policy">Privacy Policy</a></p>
  </div>
  <div id="feedbackBox">
      <div id="feedcloseX" class="feedclose t_button">X</div>
    <form id="feedform" action="http://doc.qt.nokia.com/docFeedbck/feedback.php" method="get">
      <p id="noteHead">Thank you for giving your feedback. <div class="note">Make sure it is related to this specific page. For more general bugs and 
      requests, please use the <a href="http://bugreports.qt.nokia.com/secure/Dashboard.jspa">Qt Bug Tracker</a>.</div></p>
      <p><textarea id="feedbox" name="feedText" rows="5" cols="40"></textarea></p>
      <p><input id="feedsubmit" class="feedclose" type="submit" name="feedback" /></p>
    </form>
  </div>
  <div id="blurpage">
  </div>
  <!--/div -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-4457116-5']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</body>
</html>
